name: ğŸ”’ Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©UTC 02:00 (åŒ—äº¬æ—¶é—´10:00) æ‰§è¡Œå®‰å…¨æ‰«æ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'æ‰«æç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - dependencies-only
          - secrets-only

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ğŸ” ä¾èµ–æ¼æ´æ‰«æ
  dependency-vulnerability-scan:
    name: ğŸ” ä¾èµ–æ¼æ´æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ”§ å®‰è£…cargo-audit
        run: cargo install cargo-audit

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-security-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ” è¿è¡Œcargo-auditæ‰«æ
        run: |
          echo "ğŸ” å¼€å§‹ä¾èµ–æ¼æ´æ‰«æ..."
          
          # æ›´æ–°æ¼æ´æ•°æ®åº“
          cargo audit --version
          
          # æ‰§è¡Œæ¼æ´æ‰«æ
          cargo audit --format json > audit-report.json 2>&1 || true
          cargo audit || true
          
          echo "ğŸ“Š ç”Ÿæˆæ‰«ææ‘˜è¦..."
          
          if [ -f audit-report.json ]; then
            # è§£ææ‰«æç»“æœ
            VULN_COUNT=$(jq -r '.vulnerabilities.count // 0' audit-report.json 2>/dev/null || echo "0")
            echo "ğŸ” å‘ç°æ¼æ´æ•°é‡: $VULN_COUNT"
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "âš ï¸ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯¦è§ä¸‹æ–¹æŠ¥å‘Š"
              jq -r '.vulnerabilities.list[]? | "ğŸš¨ " + .advisory.id + ": " + .advisory.title' audit-report.json 2>/dev/null || true
            else
              echo "âœ… æœªå‘ç°å·²çŸ¥æ¼æ´"
            fi
          else
            echo "âš ï¸ æ— æ³•ç”ŸæˆJSONæŠ¥å‘Šï¼Œä½¿ç”¨æ–‡æœ¬è¾“å‡º"
          fi

      - name: ğŸ“Š ä¾èµ–è®¸å¯è¯æ£€æŸ¥
        run: |
          echo "ğŸ“Š æ£€æŸ¥ä¾èµ–è®¸å¯è¯..."
          
          # å®‰è£…cargo-license
          cargo install cargo-license --quiet || true
          
          # ç”Ÿæˆè®¸å¯è¯æŠ¥å‘Š
          if command -v cargo-license &> /dev/null; then
            cargo license --json > license-report.json 2>/dev/null || true
            cargo license || echo "âš ï¸ è®¸å¯è¯æ£€æŸ¥å·¥å…·ä¸å¯ç”¨"
          else
            echo "âš ï¸ cargo-licenseæœªå®‰è£…ï¼Œè·³è¿‡è®¸å¯è¯æ£€æŸ¥"
          fi

      - name: ğŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report-${{ github.sha }}
          path: |
            audit-report.json
            license-report.json
          retention-days: 90

  # ğŸ•µï¸ å¯†é’¥æ³„éœ²æ‰«æ
  secrets-scan:
    name: ğŸ•µï¸ å¯†é’¥æ³„éœ²æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥æ‰«ææ‰€æœ‰æäº¤

      - name: ğŸ” å®‰è£…TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: ğŸ•µï¸ æ‰«æå¯†é’¥æ³„éœ²
        run: |
          echo "ğŸ•µï¸ å¼€å§‹æ‰«ææ½œåœ¨çš„å¯†é’¥æ³„éœ²..."
          
          # æ‰«æGitå†å²ä¸­çš„å¯†é’¥
          trufflehog git file://. \
            --json \
            --no-verification \
            --max-depth=50 \
            --include-detectors=all > secrets-report.json 2>&1 || true
          
          # åˆ†ææ‰«æç»“æœ
          if [ -f secrets-report.json ]; then
            SECRET_COUNT=$(wc -l < secrets-report.json)
            echo "ğŸ” æ‰«æå®Œæˆï¼Œå‘ç° $SECRET_COUNT ä¸ªæ½œåœ¨å¯†é’¥"
            
            if [ "$SECRET_COUNT" -gt 0 ]; then
              echo "âš ï¸ å‘ç°æ½œåœ¨å¯†é’¥æ³„éœ²ï¼š"
              head -10 secrets-report.json | jq -r 'select(.Raw) | "ğŸ”‘ " + .DetectorName + ": " + .Raw[0:20] + "..."' 2>/dev/null || true
              echo "ğŸš¨ è¯·æ£€æŸ¥å®Œæ•´æŠ¥å‘Šå¹¶ç«‹å³å¤„ç†ä»»ä½•çœŸå®çš„å¯†é’¥æ³„éœ²"
            else
              echo "âœ… æœªå‘ç°æ˜æ˜¾çš„å¯†é’¥æ³„éœ²"
            fi
          fi

      - name: ğŸ” é™æ€æ–‡ä»¶å¯†é’¥æ‰«æ
        run: |
          echo "ğŸ” æ‰«æé™æ€æ–‡ä»¶ä¸­çš„æ•æ„Ÿä¿¡æ¯..."
          
          # æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶
          echo "ğŸ“‹ æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶..."
          find . -name "*.env*" -not -path "./target/*" -exec echo "ğŸ“„ {}" \; -exec head -5 {} \; || true
          
          # æ£€æŸ¥å¯èƒ½åŒ…å«å¯†é’¥çš„æ–‡ä»¶
          echo "ğŸ“‹ æ£€æŸ¥å…¶ä»–æ•æ„Ÿæ–‡ä»¶æ¨¡å¼..."
          find . -type f \( -name "*.key" -o -name "*.pem" -o -name "*.p12" -o -name "*.jks" \) \
            -not -path "./target/*" -not -path "./.git/*" -exec ls -la {} \; || true
          
          # æ£€æŸ¥ç¡¬ç¼–ç çš„å¯ç–‘æ¨¡å¼
          echo "ğŸ“‹ æ£€æŸ¥ç¡¬ç¼–ç å¯†é’¥æ¨¡å¼..."
          grep -r -i -n \
            -E "(password|secret|key|token|api_key).*=.*['\"][^'\"]{10,}" \
            --include="*.rs" --include="*.toml" --include="*.yaml" --include="*.yml" \
            --exclude-dir=target --exclude-dir=.git \
            . | head -20 || echo "âœ… æœªå‘ç°ç¡¬ç¼–ç å¯†é’¥æ¨¡å¼"

      - name: ğŸ“¤ ä¸Šä¼ å¯†é’¥æ‰«ææŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-report-${{ github.sha }}
          path: secrets-report.json
          retention-days: 90

  # ğŸ”’ Rustå®‰å…¨å®¡è®¡
  rust-security-audit:
    name: ğŸ”’ Rustå®‰å…¨å®¡è®¡
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-rust-security-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ” å®‰è£…å®‰å…¨æ£€æŸ¥å·¥å…·
        run: |
          echo "ğŸ”§ å®‰è£…Rustå®‰å…¨å·¥å…·..."
          cargo install cargo-geiger --quiet || echo "âš ï¸ cargo-geigerå®‰è£…å¤±è´¥"
          cargo install cargo-outdated --quiet || echo "âš ï¸ cargo-outdatedå®‰è£…å¤±è´¥"

      - name: ğŸ”’ è¿è¡Œå®‰å…¨ç›¸å…³çš„Clippyæ£€æŸ¥
        run: |
          echo "ğŸ”’ è¿è¡Œå®‰å…¨ç›¸å…³çš„é™æ€åˆ†æ..."
          
          # è¿è¡Œå®‰å…¨ç›¸å…³çš„clippyè§„åˆ™
          cargo clippy --all-targets --all-features -- \
            -W clippy::integer_arithmetic \
            -W clippy::unwrap_used \
            -W clippy::expect_used \
            -W clippy::panic \
            -W clippy::unimplemented \
            -W clippy::todo \
            -W clippy::mem_forget \
            -W clippy::mem_replace_with_uninit \
            -W clippy::cast_ptr_alignment \
            -W clippy::mut_from_ref \
            -A clippy::too_many_arguments \
            || echo "âš ï¸ å‘ç°æ½œåœ¨å®‰å…¨é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹è¾“å‡º"

      - name: ğŸ” æ£€æŸ¥unsafeä»£ç ä½¿ç”¨
        run: |
          echo "ğŸ” æ‰«æunsafeä»£ç ä½¿ç”¨..."
          
          if command -v cargo-geiger &> /dev/null; then
            cargo geiger --format GitHubMarkdown > geiger-report.md 2>/dev/null || true
            
            if [ -f geiger-report.md ]; then
              echo "ğŸ“Š Unsafeä»£ç ç»Ÿè®¡:"
              cat geiger-report.md
            fi
          else
            echo "âš ï¸ cargo-geigerä¸å¯ç”¨ï¼Œæ‰‹åŠ¨æ‰«æunsafeå…³é”®å­—"
            grep -r "unsafe" --include="*.rs" src/ crates/ || echo "âœ… æœªå‘ç°unsafeä»£ç å—"
          fi

      - name: ğŸ“Š æ£€æŸ¥è¿‡æ—¶ä¾èµ–
        run: |
          echo "ğŸ“Š æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–..."
          
          if command -v cargo-outdated &> /dev/null; then
            echo "â° è¿è¡Œcargo-outdatedï¼ˆ30ç§’è¶…æ—¶ï¼‰..."
            timeout 30s cargo outdated --format json > outdated-report.json 2>/dev/null || echo "âš ï¸ ä¾èµ–æ£€æŸ¥è¶…æ—¶æˆ–å¤±è´¥ï¼Œè¿™åœ¨å¤§å‹é¡¹ç›®ä¸­å¾ˆå¸¸è§"
            timeout 15s cargo outdated || echo "âš ï¸ ä¾èµ–æ£€æŸ¥å¤±è´¥æˆ–è¶…æ—¶"
          else
            echo "âš ï¸ cargo-outdatedä¸å¯ç”¨ï¼Œè·³è¿‡è¿‡æ—¶ä¾èµ–æ£€æŸ¥"
          fi

      - name: ğŸ“¤ ä¸Šä¼ Rustå®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: rust-security-report-${{ github.sha }}
          path: |
            geiger-report.md
            outdated-report.json
          retention-days: 90

  # ğŸŒ ç½‘ç»œå®‰å…¨é…ç½®æ£€æŸ¥
  network-security-check:
    name: ğŸŒ ç½‘ç»œå®‰å…¨é…ç½®æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” æ£€æŸ¥ç½‘ç»œé…ç½®å®‰å…¨æ€§
        run: |
          echo "ğŸŒ æ£€æŸ¥ç½‘ç»œå®‰å…¨é…ç½®..."
          
          # æ£€æŸ¥CORSé…ç½®
          echo "ğŸ“‹ æ£€æŸ¥CORSé…ç½®..."
          find . -name "*.rs" -exec grep -l "cors\|CORS" {} \; | while read file; do
            echo "ğŸ“„ æ–‡ä»¶: $file"
            grep -n -A 3 -B 3 -i "cors\|allow_origin\|allow_methods" "$file" || true
          done
          
          # æ£€æŸ¥TLS/SSLé…ç½®
          echo "ğŸ“‹ æ£€æŸ¥TLSé…ç½®..."
          find . -name "*.rs" -o -name "*.toml" -o -name "*.yaml" -o -name "*.yml" | \
            xargs grep -l -i "tls\|ssl\|https\|certificate" | head -10 | while read file; do
              echo "ğŸ“„ TLSç›¸å…³æ–‡ä»¶: $file"
              grep -n -i "tls\|ssl\|https\|cert" "$file" | head -5 || true
          done
          
          # æ£€æŸ¥è®¤è¯é…ç½®
          echo "ğŸ“‹ æ£€æŸ¥è®¤è¯é…ç½®..."
          grep -r -n -i "auth\|jwt\|token\|bearer" --include="*.rs" crates/ | head -10 || true
          
          # æ£€æŸ¥æ•°æ®åº“è¿æ¥å®‰å…¨æ€§
          echo "ğŸ“‹ æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
          grep -r -n "mongodb://\|redis://" --include="*.rs" --include="*.env*" . | \
            grep -v "localhost\|127.0.0.1" || echo "âœ… æœªå‘ç°å¤–éƒ¨æ•°æ®åº“è¿æ¥"

      - name: ğŸ” æ£€æŸ¥è¾“å…¥éªŒè¯
        run: |
          echo "ğŸ” æ£€æŸ¥è¾“å…¥éªŒè¯æœºåˆ¶..."
          
          # æ£€æŸ¥validatorä½¿ç”¨
          echo "ğŸ“‹ æ£€æŸ¥è¾“å…¥éªŒè¯åº“ä½¿ç”¨..."
          grep -r -n "validator\|Validate\|#\[validate" --include="*.rs" crates/ | head -10 || true
          
          # æ£€æŸ¥SQLæ³¨å…¥é˜²æŠ¤ï¼ˆè™½ç„¶ä½¿ç”¨MongoDBï¼Œä½†æ£€æŸ¥ä¸€èˆ¬æ³¨å…¥é˜²æŠ¤ï¼‰
          echo "ğŸ“‹ æ£€æŸ¥æ³¨å…¥æ”»å‡»é˜²æŠ¤..."
          grep -r -n -i "sanitize\|escape\|validate_input" --include="*.rs" crates/ || echo "âš ï¸ å»ºè®®æ·»åŠ æ›´å¤šè¾“å…¥éªŒè¯"

  # ğŸ“‹ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
  security-summary:
    name: ğŸ“‹ å®‰å…¨æ‰«ææ€»ç»“
    runs-on: ubuntu-latest
    needs: [dependency-vulnerability-scan, secrets-scan, rust-security-audit, network-security-check]
    if: always()
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç   
        uses: actions/checkout@v4

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰å®‰å…¨æŠ¥å‘Š
        uses: actions/download-artifact@v4
        with:
          pattern: '*-report-${{ github.sha }}'
          path: security-reports/

      - name: ğŸ“‹ ç”Ÿæˆå®‰å…¨æ€»ç»“æŠ¥å‘Š
        run: |
          echo "ğŸ“‹ ç”Ÿæˆç»¼åˆå®‰å…¨æŠ¥å‘Š..."
          
          cat > security-summary.md << EOF
          # ğŸ”’ Coinfairå®‰å…¨æ‰«ææŠ¥å‘Š
          
          **æ‰«ææ—¶é—´**: $(date)  
          **Gitåˆ†æ”¯**: ${{ github.ref_name }}  
          **æäº¤å“ˆå¸Œ**: ${{ github.sha }}  
          **æ‰«æç±»å‹**: ${{ github.event.inputs.scan_type || 'automatic' }}
          
          ## ğŸ“Š æ‰«ææ¦‚è¿°
          
          | æ‰«æç±»å‹ | çŠ¶æ€ | ç»“æœ |
          |---------|-----|------|
          | ä¾èµ–æ¼æ´æ‰«æ | ${{ needs.dependency-vulnerability-scan.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.dependency-vulnerability-scan.result }} |
          | å¯†é’¥æ³„éœ²æ‰«æ | ${{ needs.secrets-scan.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.secrets-scan.result }} |
          | Rustå®‰å…¨å®¡è®¡ | ${{ needs.rust-security-audit.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.rust-security-audit.result }} |
          | ç½‘ç»œå®‰å…¨æ£€æŸ¥ | ${{ needs.network-security-check.result == 'success' && 'âœ…' || 'âŒ' }} | ${{ needs.network-security-check.result }} |
          
          ## ğŸ” è¯¦ç»†ç»“æœ
          
          ### ä¾èµ–æ¼æ´
          - æ‰«æäº†æ‰€æœ‰Rustä¾èµ–åŒ…
          - æ£€æŸ¥äº†å·²çŸ¥CVEæ¼æ´æ•°æ®åº“
          - éªŒè¯äº†è®¸å¯è¯åˆè§„æ€§
          
          ### å¯†é’¥å®‰å…¨
          - æ‰«æäº†Gitå†å²è®°å½•
          - æ£€æŸ¥äº†é…ç½®æ–‡ä»¶
          - éªŒè¯äº†ç¡¬ç¼–ç å¯†é’¥æ¨¡å¼
          
          ### ä»£ç å®‰å…¨
          - è¿è¡Œäº†å®‰å…¨ç›¸å…³çš„Clippyè§„åˆ™
          - æ£€æŸ¥äº†unsafeä»£ç ä½¿ç”¨
          - åˆ†æäº†è¿‡æ—¶ä¾èµ–é£é™©
          
          ### ç½‘ç»œå®‰å…¨
          - éªŒè¯äº†CORSé…ç½®
          - æ£€æŸ¥äº†TLS/SSLè®¾ç½®
          - è¯„ä¼°äº†è®¤è¯æœºåˆ¶
          
          ## ğŸš¨ å»ºè®®è¡ŒåŠ¨
          
          1. **é«˜ä¼˜å…ˆçº§**: ç«‹å³ä¿®å¤ä»»ä½•å‘ç°çš„CVEæ¼æ´
          2. **ä¸­ä¼˜å…ˆçº§**: æ›´æ–°è¿‡æ—¶çš„ä¾èµ–åŒ…
          3. **ä½ä¼˜å…ˆçº§**: ä¼˜åŒ–ä»£ç è´¨é‡å’Œå®‰å…¨æœ€ä½³å®è·µ
          
          ## ğŸ“ è”ç³»æ–¹å¼
          
          å¦‚æœ‰å®‰å…¨é—®é¢˜ï¼Œè¯·è”ç³»å®‰å…¨å›¢é˜Ÿæˆ–åœ¨GitHub Issuesä¸­æŠ¥å‘Šã€‚
          
          ---
          *æ­¤æŠ¥å‘Šç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*
          EOF
          
          echo "âœ… å®‰å…¨æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ ç»¼åˆå®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-${{ github.sha }}
          path: security-summary.md
          retention-days: 180

      - name: ğŸš¨ å‘é€å®‰å…¨é€šçŸ¥
        if: contains(needs.*.result, 'failure')
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ğŸš¨ Coinfairå®‰å…¨æ‰«æå‘ç°é—®é¢˜!\nğŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æäº¤è€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\nğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\nâš ï¸ è¯·ç«‹å³æ£€æŸ¥å®‰å…¨æŠ¥å‘Šå¹¶é‡‡å–å¿…è¦æªæ–½\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "â„¹ï¸ SLACK_WEBHOOK_URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi

      - name: âœ… å‘é€æˆåŠŸé€šçŸ¥
        if: needs.dependency-vulnerability-scan.result == 'success' && needs.secrets-scan.result == 'success'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"âœ… Coinfairå®‰å…¨æ‰«æé€šè¿‡!\nğŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æäº¤è€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\nğŸ” æ‰€æœ‰å®‰å…¨æ£€æŸ¥å‡é€šè¿‡ï¼Œç³»ç»Ÿå®‰å…¨çŠ¶æ€è‰¯å¥½\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "â„¹ï¸ SLACK_WEBHOOK_URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi
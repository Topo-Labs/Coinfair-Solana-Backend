name: ğŸš€ Production Deployment (Clean)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
    # æ·»åŠ è·¯å¾„è¿‡æ»¤ï¼Œé¿å…æ–‡æ¡£æ›´æ”¹è§¦å‘éƒ¨ç½²
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'screenshots/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆå¿½ç•¥CIç¼“å­˜ï¼‰'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ğŸ”„ å°è¯•å¤ç”¨CIæ„å»ºäº§ç‰©ï¼ˆè·¨workflow artifactæŸ¥æ‰¾ï¼‰
  reuse-ci-build:
    name: ğŸ”„ å°è¯•å¤ç”¨CIæ„å»ºäº§ç‰©
    runs-on: ubuntu-latest
    if: github.event.inputs.force_rebuild != 'true'
    outputs:
      has_ci_build: ${{ steps.check-ci-build.outputs.has_ci_build }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ï¼ˆç”¨äºartifact APIè°ƒç”¨ï¼‰
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ å®‰è£…GitHub CLI
        run: |
          echo "ğŸ”§ å®‰è£…GitHub CLI..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update -qq
          sudo apt install -y gh
          gh --version

      - name: ğŸ” æŸ¥æ‰¾å¯ç”¨çš„CIæ„å»ºäº§ç‰©
        id: find-ci-artifact
        run: |
          echo "ğŸ” æŸ¥æ‰¾æœ€æ–°çš„CIæ„å»ºäº§ç‰©..."
          
          # ä½¿ç”¨GitHub APIæŸ¥æ‰¾æœ€æ–°çš„æˆåŠŸCI runä¸­çš„artifact
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          echo "ğŸ“¡ æœç´¢CI workflowçš„æˆåŠŸè¿è¡Œ..."
          CI_RUN_ID=$(gh api repos/$REPO_OWNER/$REPO_NAME/actions/workflows/ci.yml/runs \
            --jq '.workflow_runs[] | select(.conclusion == "success" and .head_sha == "'${{ github.sha }}'") | .id' \
            | head -1)
          
          if [ -n "$CI_RUN_ID" ]; then
            echo "âœ… æ‰¾åˆ°åŒ¹é…çš„CIè¿è¡Œ: $CI_RUN_ID"
            echo "ci_run_id=$CI_RUN_ID" >> $GITHUB_OUTPUT
            echo "has_ci_run=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„æˆåŠŸCIè¿è¡Œ"
            echo "has_ci_run=false" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ“¥ ä¸‹è½½CIæ„å»ºäº§ç‰©
        id: download-ci-artifact
        if: steps.find-ci-artifact.outputs.has_ci_run == 'true'
        run: |
          echo "ğŸ“¥ ä»CIè¿è¡Œä¸‹è½½æ„å»ºäº§ç‰©..."
          
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          CI_RUN_ID="${{ steps.find-ci-artifact.outputs.ci_run_id }}"
          
          # æŸ¥æ‰¾artifactå¹¶ä¸‹è½½
          ARTIFACT_URL=$(gh api repos/$REPO_OWNER/$REPO_NAME/actions/runs/$CI_RUN_ID/artifacts \
            --jq '.artifacts[] | select(.name | startswith("coinfair-binary-")) | .archive_download_url' \
            | head -1)
          
          if [ -n "$ARTIFACT_URL" ]; then
            echo "ğŸ“¥ ä¸‹è½½artifact: $ARTIFACT_URL"
            curl -L -H "Authorization: token $GITHUB_TOKEN" "$ARTIFACT_URL" -o artifact.zip
            
            if [ -f "artifact.zip" ] && [ -s "artifact.zip" ]; then
              unzip -o artifact.zip
              echo "âœ… æˆåŠŸä¸‹è½½CIæ„å»ºäº§ç‰©"
              ls -la coinfair* || echo "âš ï¸ æœªæ‰¾åˆ°coinfairæ–‡ä»¶"
            else
              echo "âŒ artifact.zipä¸‹è½½å¤±è´¥æˆ–ç©ºæ–‡ä»¶"
              exit 1
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°coinfair-binary artifact"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ” æ£€æŸ¥CIæ„å»ºäº§ç‰©
        id: check-ci-build
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©å®Œæ•´æ€§..."
          if [ -f "coinfair" ] && [ -x "coinfair" ]; then
            echo "âœ… æ‰¾åˆ°æœ‰æ•ˆçš„CIæ„å»ºäº§ç‰©"
            echo "has_ci_build=true" >> $GITHUB_OUTPUT
            ls -la coinfair
            file coinfair
            du -h coinfair
          else
            echo "âš ï¸ CIæ„å»ºäº§ç‰©ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ„å»º"
            echo "has_ci_build=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ å½“å‰ç›®å½•å†…å®¹:"
            ls -la ./ || true
          fi

      - name: ğŸ“¦ å‡†å¤‡éƒ¨ç½²åŒ…ï¼ˆå¤ç”¨æ„å»ºï¼‰
        if: steps.check-ci-build.outputs.has_ci_build == 'true'
        run: |
          echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…ï¼ˆä½¿ç”¨CIæ„å»ºäº§ç‰©ï¼‰..."
          mkdir -p deploy
          cp coinfair deploy/
          chmod +x deploy/coinfair
          
          # æ£€å‡ºä»£ç ä»¥è·å–é…ç½®æ–‡ä»¶
          git config --global --add safe.directory $GITHUB_WORKSPACE || true
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f .env.production ] && cp .env.production deploy/.env || echo "âš ï¸ .env.productionä¸å­˜åœ¨ï¼Œè·³è¿‡"
          [ -f docker-compose.yaml ] && cp docker-compose.yaml deploy/ || echo "âš ï¸ docker-compose.yamlä¸å­˜åœ¨ï¼Œè·³è¿‡"
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deploy/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²Coinfairï¼ˆä½¿ç”¨CIé¢„æ„å»ºç‰ˆæœ¬ï¼‰..."
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -f coinfair ]; then
            cp coinfair coinfair.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ… å·²å¤‡ä»½å½“å‰ç‰ˆæœ¬"
          fi
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          pkill -f coinfair || true
          sleep 2
          
          # éƒ¨ç½²æ–°ç‰ˆæœ¬
          chmod +x coinfair
          echo "âœ… æ–°ç‰ˆæœ¬éƒ¨ç½²å®Œæˆï¼ˆCIé¢„æ„å»ºï¼‰"
          
          # å¯åŠ¨æ•°æ®åº“
          docker-compose up -d || echo "âš ï¸ Docker composeå¤±è´¥ï¼Œç»§ç»­..."
          sleep 5
          
          # å¯åŠ¨æœåŠ¡
          nohup ./coinfair > coinfair.log 2>&1 &
          sleep 3
          
          # å¥åº·æ£€æŸ¥
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
              exit 0
            fi
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 2
          done
          
          echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
          exit 1
          EOF
          
          chmod +x deploy/deploy.sh
          
          echo "ğŸ“Š éƒ¨ç½²åŒ…å†…å®¹ï¼ˆCIé¢„æ„å»ºç‰ˆæœ¬ï¼‰:"
          ls -la deploy/

      - name: ğŸ“¦ ä¸Šä¼ éƒ¨ç½²åŒ…ï¼ˆå¤ç”¨ç‰ˆæœ¬ï¼‰
        if: steps.check-ci-build.outputs.has_ci_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coinfair-deployment-${{ github.sha }}
          path: deploy/
          retention-days: 30

  # ğŸ—ï¸ å¤‡ç”¨æ„å»ºï¼ˆä»…åœ¨CIæ„å»ºä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰  
  fallback-build:
    name: ğŸ—ï¸ å¤‡ç”¨æ„å»º
    runs-on: ubuntu-latest
    needs: [reuse-ci-build]
    if: always() && (needs.reuse-ci-build.outputs.has_ci_build != 'true' || github.event.inputs.force_rebuild == 'true')
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-fallback-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸš€ å¤‡ç”¨æ„å»º
        run: |
          echo "ğŸš€ æ‰§è¡Œå¤‡ç”¨æ„å»ºï¼ˆCIæ„å»ºä¸å¯ç”¨ï¼‰..."
          CARGO_ENV=Production cargo build --release --bin coinfair
          
          echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
          ls -la target/release/
          file target/release/coinfair
          du -h target/release/coinfair

      - name: ğŸ“¦ å‡†å¤‡éƒ¨ç½²åŒ…ï¼ˆå¤‡ç”¨æ„å»ºï¼‰
        run: |
          echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…ï¼ˆå¤‡ç”¨æ„å»ºç‰ˆæœ¬ï¼‰..."
          mkdir -p deploy
          cp target/release/coinfair deploy/
          cp .env.production deploy/.env || echo "âš ï¸ .env.productionä¸å­˜åœ¨ï¼Œè·³è¿‡"
          cp docker-compose.yaml deploy/ || echo "âš ï¸ docker-compose.yamlä¸å­˜åœ¨ï¼Œè·³è¿‡"
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬ï¼ˆå¤‡ç”¨ç‰ˆæœ¬ï¼‰
          cat > deploy/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²Coinfairï¼ˆå¤‡ç”¨æ„å»ºç‰ˆæœ¬ï¼‰..."
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -f coinfair ]; then
            cp coinfair coinfair.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ… å·²å¤‡ä»½å½“å‰ç‰ˆæœ¬"
          fi
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          pkill -f coinfair || true
          sleep 2
          
          # éƒ¨ç½²æ–°ç‰ˆæœ¬
          chmod +x coinfair
          echo "âœ… æ–°ç‰ˆæœ¬éƒ¨ç½²å®Œæˆï¼ˆå¤‡ç”¨æ„å»ºï¼‰"
          
          # å¯åŠ¨æ•°æ®åº“
          docker-compose up -d || echo "âš ï¸ Docker composeå¤±è´¥ï¼Œç»§ç»­..."
          sleep 5
          
          # å¯åŠ¨æœåŠ¡
          nohup ./coinfair > coinfair.log 2>&1 &
          sleep 3
          
          # å¥åº·æ£€æŸ¥
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
              exit 0
            fi
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 2
          done
          
          echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
          exit 1
          EOF
          
          chmod +x deploy/deploy.sh
          
          echo "ğŸ“Š éƒ¨ç½²åŒ…å†…å®¹ï¼ˆå¤‡ç”¨æ„å»ºï¼‰:"
          ls -la deploy/

      - name: ğŸ“¦ ä¸Šä¼ éƒ¨ç½²åŒ…ï¼ˆå¤‡ç”¨ç‰ˆæœ¬ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: coinfair-deployment-${{ github.sha }}
          path: deploy/
          retention-days: 30

  # ğŸš€ AWS EC2 éƒ¨ç½²ï¼ˆä½¿ç”¨æ™ºèƒ½æ„å»ºé€‰æ‹©ï¼‰
  deploy-aws:
    name: ğŸš€ AWS EC2 éƒ¨ç½²ï¼ˆæ™ºèƒ½ç‰ˆï¼‰
    runs-on: ubuntu-latest
    needs: [reuse-ci-build, fallback-build]
    if: always() && !cancelled() && (needs.reuse-ci-build.result == 'success' || needs.fallback-build.result == 'success')
    # æ³¨æ„ï¼šä¼˜å…ˆä½¿ç”¨CIæ„å»ºï¼Œå…¶æ¬¡ä½¿ç”¨å¤‡ç”¨æ„å»º
    
    steps:
      - name: ğŸ“¥ æ™ºèƒ½ä¸‹è½½éƒ¨ç½²åŒ…
        run: |
          echo "ğŸ“¥ æ™ºèƒ½é€‰æ‹©æœ€ä½³éƒ¨ç½²åŒ…..."
          
          # ä¼˜å…ˆä½¿ç”¨CIå¤ç”¨ç‰ˆæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [ "${{ needs.reuse-ci-build.result }}" == "success" ] && [ "${{ needs.reuse-ci-build.outputs.has_ci_build }}" == "true" ]; then
            echo "âœ… ä½¿ç”¨CIå¤ç”¨æ„å»ºç‰ˆæœ¬"
            BUILD_TYPE="ci-reused"
          elif [ "${{ needs.fallback-build.result }}" == "success" ]; then
            echo "âœ… ä½¿ç”¨å¤‡ç”¨æ„å»ºç‰ˆæœ¬"
            BUILD_TYPE="fallback"
          else
            echo "âŒ æ‰€æœ‰æ„å»ºæ–¹å¼éƒ½å¤±è´¥"
            exit 1
          fi
          
          echo "build_type=$BUILD_TYPE" >> $GITHUB_ENV

      - name: ğŸ“¥ ä¸‹è½½é€‰å®šçš„éƒ¨ç½²åŒ…
        uses: actions/download-artifact@v4
        with:
          name: coinfair-deployment-${{ github.sha }}
          path: deploy/
        continue-on-error: false

      - name: ğŸ”‘ é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ ä¸Šä¼ åˆ°æœåŠ¡å™¨
        run: |
          echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨..."
          scp -r deploy/* ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/opt/coinfair/
          
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"

      - name: ğŸš€ æ‰§è¡Œéƒ¨ç½²
        run: |
          echo "ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²ï¼ˆ${{ env.build_type }}ç‰ˆæœ¬ï¼‰..."
          ssh ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
            cd /opt/coinfair
            
            echo "ğŸ“‹ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            
            echo "ğŸš€ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            ./deploy.sh
            
            echo "ğŸ“Š éƒ¨ç½²åçŠ¶æ€æ£€æŸ¥:"
            ps aux | grep coinfair | head -5
            
            echo "ğŸ” æœåŠ¡çŠ¶æ€æ£€æŸ¥:"
            curl -s http://localhost:8000/api/v1/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"
            
            echo "âœ… éƒ¨ç½²å®Œæˆ! (ä½¿ç”¨${{ env.build_type }}æ„å»º)"
          EOF

      - name: ğŸ” éƒ¨ç½²åéªŒè¯
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."
          
          # ç­‰å¾…æœåŠ¡ç¨³å®š
          sleep 10
          
          # å¥åº·æ£€æŸ¥
          ssh ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
            # æ£€æŸ¥è¿›ç¨‹
            if pgrep -f coinfair > /dev/null; then
              echo "âœ… Coinfairè¿›ç¨‹æ­£åœ¨è¿è¡Œ"
            else
              echo "âŒ Coinfairè¿›ç¨‹æœªæ‰¾åˆ°"
              exit 1
            fi
            
            # æ£€æŸ¥API
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥"
              echo "ğŸ“‹ æœåŠ¡æ—¥å¿— (æœ€å20è¡Œ):"
              tail -20 coinfair.log
              exit 1
            fi
            
            echo "ğŸ‰ éƒ¨ç½²éªŒè¯æˆåŠŸ!"
          EOF

  # ğŸ“§ éƒ¨ç½²é€šçŸ¥
  notify-deployment:
    name: ğŸ“§ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-aws]
    if: always()
    
    steps:
      - name: ğŸ“§ å‘é€éƒ¨ç½²é€šçŸ¥
        if: contains(needs.*.result, 'success')
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ğŸ‰ Coinfair éƒ¨ç½²æˆåŠŸ!\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ éƒ¨ç½²è€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "â„¹ï¸ SLACK_WEBHOOK_URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi

      - name: ğŸš¨ å‘é€å¤±è´¥é€šçŸ¥  
        if: contains(needs.*.result, 'failure')
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"âŒ Coinfair éƒ¨ç½²å¤±è´¥!\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æ“ä½œè€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "â„¹ï¸ SLACK_WEBHOOK_URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi
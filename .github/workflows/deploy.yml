name: ğŸš€ Production Deployment

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½² (è·³è¿‡æµ‹è¯•)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ğŸ” éƒ¨ç½²å‰æ£€æŸ¥
  pre-deploy-check:
    name: ğŸ” éƒ¨ç½²å‰æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      deploy_env: ${{ steps.set_env.outputs.deploy_env }}
      skip_tests: ${{ steps.set_env.outputs.skip_tests }}
    
    steps:
      - name: ğŸ“‹ ç¡®å®šéƒ¨ç½²ç¯å¢ƒ
        id: set_env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "deploy_env=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "skip_tests=${{ github.event.inputs.force_deploy }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "deploy_env=production" >> $GITHUB_OUTPUT
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          else
            echo "deploy_env=staging" >> $GITHUB_OUTPUT
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ğŸ¯ éƒ¨ç½²ç¯å¢ƒ: ${{ steps.set_env.outputs.deploy_env }}"
          echo "â­ï¸ è·³è¿‡æµ‹è¯•: ${{ steps.set_env.outputs.skip_tests }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ğŸ“ æäº¤: ${{ github.sha }}"

  # ğŸ§ª å¿«é€ŸéªŒè¯æµ‹è¯•
  quick-validation:
    name: ğŸ§ª å¿«é€ŸéªŒè¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.skip_tests == 'false'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-deploy-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: âš¡ å¿«é€Ÿæ„å»ºæ£€æŸ¥
        run: cargo check --release --bin coinfair

      - name: ğŸ“ æ£€æŸ¥æ ¸å¿ƒåŒ…ç¼–è¯‘
        run: |
          echo "ğŸ“ æ£€æŸ¥æ ¸å¿ƒç»„ä»¶ç¼–è¯‘..."
          cargo check --package utils --release --quiet || echo "âš ï¸ utilsåŒ…ç¼–è¯‘å¤±è´¥"
          cargo check --package database --release --quiet || echo "âš ï¸ databaseåŒ…ç¼–è¯‘å¤±è´¥"
          echo "âœ… æ ¸å¿ƒåŒ…æ£€æŸ¥å®Œæˆ"

  # ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬  
  build-production:
    name: ğŸ—ï¸ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, quick-validation]
    if: always() && (needs.quick-validation.result == 'success' || needs.pre-deploy-check.outputs.skip_tests == 'true')
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-production-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸš€ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: |
          echo "ğŸš€ å¼€å§‹ç”Ÿäº§æ„å»º..."
          CARGO_ENV=Production cargo build --release --bin coinfair
          
          echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
          ls -la target/release/
          file target/release/coinfair
          du -h target/release/coinfair
          
          echo "ğŸ” æ£€æŸ¥äºŒè¿›åˆ¶ä¾èµ–:"
          ldd target/release/coinfair || true

      - name: ğŸ“¦ å‡†å¤‡éƒ¨ç½²åŒ…
        run: |
          echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…..."
          mkdir -p deploy
          cp target/release/coinfair deploy/
          cp .env.production deploy/.env
          cp docker-compose.yaml deploy/
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deploy/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²Coinfair..."
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -f coinfair ]; then
            cp coinfair coinfair.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ… å·²å¤‡ä»½å½“å‰ç‰ˆæœ¬"
          fi
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          pkill -f coinfair || true
          sleep 2
          
          # éƒ¨ç½²æ–°ç‰ˆæœ¬
          chmod +x coinfair
          echo "âœ… æ–°ç‰ˆæœ¬éƒ¨ç½²å®Œæˆ"
          
          # å¯åŠ¨æ•°æ®åº“
          docker-compose up -d
          sleep 5
          
          # å¯åŠ¨æœåŠ¡
          nohup ./coinfair > coinfair.log 2>&1 &
          sleep 3
          
          # å¥åº·æ£€æŸ¥
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
              exit 0
            fi
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 2
          done
          
          echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
          exit 1
          EOF
          
          chmod +x deploy/deploy.sh
          
          echo "ğŸ“Š éƒ¨ç½²åŒ…å†…å®¹:"
          ls -la deploy/

      - name: ğŸ“¦ ä¸Šä¼ éƒ¨ç½²åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: coinfair-deployment-${{ github.sha }}
          path: deploy/
          retention-days: 30

  # ğŸš€ AWS EC2 éƒ¨ç½²
  deploy-aws:
    name: ğŸš€ AWS EC2 éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, build-production]
    environment: ${{ needs.pre-deploy-check.outputs.deploy_env }}
    
    steps:
      - name: ğŸ“¥ ä¸‹è½½éƒ¨ç½²åŒ…
        uses: actions/download-artifact@v4
        with:
          name: coinfair-deployment-${{ github.sha }}
          path: deploy/

      - name: ğŸ”‘ é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ ä¸Šä¼ åˆ°æœåŠ¡å™¨
        run: |
          echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨..."
          scp -r deploy/* ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/opt/coinfair/
          
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"

      - name: ğŸš€ æ‰§è¡Œéƒ¨ç½²
        run: |
          echo "ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
          ssh ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
            cd /opt/coinfair
            
            echo "ğŸ“‹ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            
            echo "ğŸš€ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            ./deploy.sh
            
            echo "ğŸ“Š éƒ¨ç½²åçŠ¶æ€æ£€æŸ¥:"
            ps aux | grep coinfair | head -5
            
            echo "ğŸ” æœåŠ¡çŠ¶æ€æ£€æŸ¥:"
            curl -s http://localhost:8000/api/v1/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"
            
            echo "âœ… éƒ¨ç½²å®Œæˆ!"
          EOF

      - name: ğŸ” éƒ¨ç½²åéªŒè¯
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."
          
          # ç­‰å¾…æœåŠ¡ç¨³å®š
          sleep 10
          
          # å¥åº·æ£€æŸ¥
          ssh ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << 'EOF'
            # æ£€æŸ¥è¿›ç¨‹
            if pgrep -f coinfair > /dev/null; then
              echo "âœ… Coinfairè¿›ç¨‹æ­£åœ¨è¿è¡Œ"
            else
              echo "âŒ Coinfairè¿›ç¨‹æœªæ‰¾åˆ°"
              exit 1
            fi
            
            # æ£€æŸ¥API
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥"
              echo "ğŸ“‹ æœåŠ¡æ—¥å¿— (æœ€å20è¡Œ):"
              tail -20 coinfair.log
              exit 1
            fi
            
            echo "ğŸ‰ éƒ¨ç½²éªŒè¯æˆåŠŸ!"
          EOF

  # ğŸ“Š Dockeré•œåƒæ„å»º (å¯é€‰)
  build-docker:
    name: ğŸ“Š Dockeré•œåƒæ„å»º
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.deploy_env == 'production'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”‘ ç™»å½•Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ æ„å»ºDockeré•œåƒ
        run: |
          cat > Dockerfile << 'EOF'
          FROM rust:1.75 as builder
          
          WORKDIR /app
          COPY . .
          
          RUN cargo build --release --bin coinfair
          
          FROM ubuntu:22.04
          
          RUN apt-get update && apt-get install -y \
              ca-certificates \
              curl \
              && rm -rf /var/lib/apt/lists/*
          
          WORKDIR /opt/coinfair
          
          COPY --from=builder /app/target/release/coinfair .
          COPY --from=builder /app/.env.production .env
          
          EXPOSE 8000
          
          CMD ["./coinfair"]
          EOF
          
          docker build -t coinfair:${{ github.sha }} .
          docker tag coinfair:${{ github.sha }} coinfair:latest
          
          echo "ğŸ“Š é•œåƒæ„å»ºå®Œæˆ"
          docker images | grep coinfair

      - name: ğŸ“¤ æ¨é€Dockeré•œåƒ
        if: github.ref == 'refs/heads/main'
        run: |
          docker push coinfair:${{ github.sha }}
          docker push coinfair:latest
          echo "âœ… Dockeré•œåƒæ¨é€å®Œæˆ"

  # ğŸ“§ éƒ¨ç½²é€šçŸ¥
  notify-deployment:
    name: ğŸ“§ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-aws, build-docker]
    if: always()
    
    steps:
      - name: ğŸ“§ å‘é€éƒ¨ç½²é€šçŸ¥
        if: contains(needs.*.result, 'success')
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸ‰ Coinfair éƒ¨ç½²æˆåŠŸ!\nğŸ“‹ ç¯å¢ƒ: ${{ needs.pre-deploy-check.outputs.deploy_env }}\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ éƒ¨ç½²è€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\nğŸ”— æŸ¥çœ‹: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true

      - name: ğŸš¨ å‘é€å¤±è´¥é€šçŸ¥  
        if: contains(needs.*.result, 'failure')
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âŒ Coinfair éƒ¨ç½²å¤±è´¥!\nğŸ“‹ ç¯å¢ƒ: ${{ needs.pre-deploy-check.outputs.deploy_env }}\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æ“ä½œè€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\nğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true
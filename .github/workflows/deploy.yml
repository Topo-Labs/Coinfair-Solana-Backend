name: ğŸš€ Production Deployment (Simplified)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
    # æ·»åŠ è·¯å¾„è¿‡æ»¤ï¼Œé¿å…æ–‡æ¡£æ›´æ”¹è§¦å‘éƒ¨ç½²
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'screenshots/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ğŸ—ï¸ æ„å»ºå’Œéƒ¨ç½²ï¼ˆç®€åŒ–ç‰ˆï¼‰
  build-and-deploy:
    name: ğŸ—ï¸ æ„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-deploy-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸš€ æ„å»ºå‘å¸ƒç‰ˆæœ¬
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºç”Ÿäº§ç‰ˆæœ¬..."
          CARGO_ENV=Production cargo build --release --bin coinfair
          
          echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
          ls -la target/release/
          file target/release/coinfair
          du -h target/release/coinfair

      - name: ğŸ“¦ å‡†å¤‡éƒ¨ç½²åŒ…
        run: |
          echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…..."
          mkdir -p deploy
          cp target/release/coinfair deploy/
          cp .env.production deploy/.env || echo "âš ï¸ .env.productionä¸å­˜åœ¨ï¼Œè·³è¿‡"
          cp docker-compose.yaml deploy/ || echo "âš ï¸ docker-compose.yamlä¸å­˜åœ¨ï¼Œè·³è¿‡"
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deploy/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²Coinfair..."
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -f coinfair ]; then
            cp coinfair coinfair.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ… å·²å¤‡ä»½å½“å‰ç‰ˆæœ¬"
          fi
          
          # éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆæœåŠ¡å·²åœ¨ä¸Šä¼ å‰åœæ­¢ï¼‰
          chmod +x coinfair
          echo "âœ… æ–°ç‰ˆæœ¬éƒ¨ç½²å®Œæˆ"
          
          # å¯åŠ¨æ•°æ®åº“
          docker compose up -d || echo "âš ï¸ Docker composeå¤±è´¥ï¼Œç»§ç»­..."
          sleep 5
          
          # å¯åŠ¨æœåŠ¡
          nohup ./coinfair > coinfair.log 2>&1 &
          sleep 3
          
          # å¥åº·æ£€æŸ¥
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
              exit 0
            fi
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/30)"
            sleep 2
          done
          
          echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
          exit 1
          EOF
          
          chmod +x deploy/deploy.sh
          
          echo "ğŸ“Š éƒ¨ç½²åŒ…å†…å®¹:"
          ls -la deploy/

      - name: ğŸ”‘ é…ç½®SSHå¯†é’¥
        run: |
          echo "ğŸ”‘ é…ç½®SSHè¿æ¥..."
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          echo "ğŸ” éªŒè¯ç§é’¥æ ¼å¼..."
          head -1 ~/.ssh/id_rsa | grep -q "BEGIN" && echo "âœ… ç§é’¥æ ¼å¼æ­£ç¡®" || echo "âŒ ç§é’¥æ ¼å¼å¼‚å¸¸"
          
          echo "ğŸ” è·å–æœåŠ¡å™¨æŒ‡çº¹..."
          ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "âŒ æ— æ³•è·å–æœåŠ¡å™¨æŒ‡çº¹"
          
          echo "ğŸ” æµ‹è¯•ç½‘ç»œè¿æ¥..."
          ping -c 2 ${{ secrets.AWS_HOST }} || echo "âŒ pingå¤±è´¥"
          nc -zv ${{ secrets.AWS_HOST }} 22 || echo "âŒ SSHç«¯å£ä¸å¯è¾¾"

      - name: ğŸ§ª SSHè¿æ¥æµ‹è¯•
        run: |
          echo "ğŸ§ª æµ‹è¯•SSHè¿æ¥..."
          ssh -vvv -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
              ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
              "echo 'âœ… SSHè¿æ¥æˆåŠŸ'; hostname; whoami; pwd" 2>&1 || \
              { echo "âŒ SSHè¿æ¥å¤±è´¥"; exit 1; }

      - name: ğŸ“¤ åœæ­¢æ—§æœåŠ¡
        run: |
          echo "ğŸ“¤ å°è¯•åœæ­¢æ—§æœåŠ¡ä»¥é‡Šæ”¾æ–‡ä»¶..."
          if ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
                 ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
                 "pkill -f coinfair || true" 2>/dev/null; then
            echo "âœ… æˆåŠŸè¿æ¥æœåŠ¡å™¨å¹¶åœæ­¢æ—§æœåŠ¡"
          else
            echo "âš ï¸ æ— æ³•è¿æ¥æœåŠ¡å™¨åœæ­¢æœåŠ¡ï¼Œä½†ç»§ç»­éƒ¨ç½²..."
            echo "ğŸ” å¯èƒ½çš„åŸå› ï¼š"
            echo "  - æœåŠ¡å™¨æœªè¿è¡Œ"
            echo "  - SSHè¿æ¥é—®é¢˜"
            echo "  - æœåŠ¡å·²ç»åœæ­¢"
          fi
          sleep 2

      - name: ğŸ“¤ ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨..."
          
          # è·å–ç”¨æˆ·homeç›®å½•
          USER_HOME=$(ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
                          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
                          "echo \$HOME" 2>/dev/null)
          
          if [ -z "$USER_HOME" ]; then
            echo "âŒ æ— æ³•è·å–ç”¨æˆ·homeç›®å½•ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„"
            USER_HOME="/home/${{ secrets.AWS_USER }}"
          fi
          
          DEPLOY_PATH="$USER_HOME/Topo/Coinfair-Solana-Backend"
          echo "ğŸ¯ ç›®æ ‡éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
              ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
              "mkdir -p $DEPLOY_PATH" 2>/dev/null || echo "âš ï¸ æ— æ³•åˆ›å»ºç›®å½•ï¼Œå¯èƒ½å·²å­˜åœ¨"
          
          # å¤šæ¬¡å°è¯•ä¸Šä¼ ï¼Œå¢åŠ æˆåŠŸç‡
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ å°è¯•ä¸Šä¼  (ç¬¬${attempt}/${max_attempts}æ¬¡)..."
            
            if scp -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
                   -r deploy/* ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:$DEPLOY_PATH/ 2>/dev/null; then
              echo "âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸåˆ°: $DEPLOY_PATH"
              break
            else
              echo "âŒ ç¬¬${attempt}æ¬¡ä¸Šä¼ å¤±è´¥"
              if [ $attempt -eq $max_attempts ]; then
                echo "ğŸ’¡ SSHè¿æ¥è¯Šæ–­ä¿¡æ¯ï¼š"
                echo "ğŸ” æµ‹è¯•ç½‘ç»œè¿æ¥..."
                ping -c 2 ${{ secrets.AWS_HOST }} || echo "  - pingå¤±è´¥"
                nc -zv ${{ secrets.AWS_HOST }} 22 2>&1 || echo "  - SSHç«¯å£ä¸å¯è¾¾"
                
                echo "ğŸ” æµ‹è¯•ç›®æ ‡ç›®å½•..."
                ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
                    ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
                    "ls -la $DEPLOY_PATH" 2>/dev/null || echo "  - ç›®æ ‡ç›®å½•ä¸å­˜åœ¨"
                
                echo "âŒ æ‰€æœ‰ä¸Šä¼ å°è¯•éƒ½å¤±è´¥äº†"
                exit 1
              fi
              attempt=$((attempt + 1))
              sleep 5
            fi
          done

      - name: ğŸš€ æ‰§è¡Œéƒ¨ç½²
        run: |
          echo "ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
          
          # è·å–ç”¨æˆ·homeç›®å½•å’Œéƒ¨ç½²è·¯å¾„
          USER_HOME=$(ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
                          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
                          "echo \$HOME" 2>/dev/null)
          
          if [ -z "$USER_HOME" ]; then
            USER_HOME="/home/${{ secrets.AWS_USER }}"
          fi
          
          DEPLOY_PATH="$USER_HOME/Topo/Coinfair-Solana-Backend"
          echo "ğŸ¯ éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"
          
          ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
              ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << EOF
            cd $DEPLOY_PATH
            
            echo "ğŸ“‹ å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            
            echo "ğŸš€ æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            ./deploy.sh
            
            echo "ğŸ“Š éƒ¨ç½²åçŠ¶æ€æ£€æŸ¥:"
            ps aux | grep coinfair | head -5
            
            echo "ğŸ” æœåŠ¡çŠ¶æ€æ£€æŸ¥:"
            curl -s http://localhost:8000/api/v1/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"
            
            echo "âœ… éƒ¨ç½²å®Œæˆ!"
          EOF

      - name: ğŸ” éƒ¨ç½²åéªŒè¯
        run: |
          echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."
          
          # ç­‰å¾…æœåŠ¡ç¨³å®š
          sleep 10
          
          # è·å–ç”¨æˆ·homeç›®å½•å’Œéƒ¨ç½²è·¯å¾„
          USER_HOME=$(ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
                          ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} \
                          "echo \$HOME" 2>/dev/null)
          
          if [ -z "$USER_HOME" ]; then
            USER_HOME="/home/${{ secrets.AWS_USER }}"
          fi
          
          DEPLOY_PATH="$USER_HOME/Topo/Coinfair-Solana-Backend"
          
          # å¥åº·æ£€æŸ¥
          ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no \
              ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }} << EOF
            cd $DEPLOY_PATH
            
            # æ£€æŸ¥è¿›ç¨‹
            if pgrep -f coinfair > /dev/null; then
              echo "âœ… Coinfairè¿›ç¨‹æ­£åœ¨è¿è¡Œ"
            else
              echo "âŒ Coinfairè¿›ç¨‹æœªæ‰¾åˆ°"
              exit 1
            fi
            
            # æ£€æŸ¥API
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥"
              echo "ğŸ“‹ æœåŠ¡æ—¥å¿— (æœ€å20è¡Œ):"
              tail -20 coinfair.log
              exit 1
            fi
            
            echo "ğŸ‰ éƒ¨ç½²éªŒè¯æˆåŠŸ!"
          EOF

  # ğŸ“§ éƒ¨ç½²é€šçŸ¥
  notify-deployment:
    name: ğŸ“§ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()
    
    steps:
      - name: ğŸ“§ å‘é€éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: needs.build-and-deploy.result == 'success'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"ğŸ‰ Coinfair éƒ¨ç½²æˆåŠŸ!\\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\\nğŸ‘¤ éƒ¨ç½²è€…: ${{ github.actor }}\\nâ° æ—¶é—´: $(date)\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "â„¹ï¸ SLACK_WEBHOOK_URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi

      - name: ğŸš¨ å‘é€éƒ¨ç½²å¤±è´¥é€šçŸ¥  
        if: needs.build-and-deploy.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"âŒ Coinfair éƒ¨ç½²å¤±è´¥!\\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\\nğŸ‘¤ æ“ä½œè€…: ${{ github.actor }}\\nâ° æ—¶é—´: $(date)\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "â„¹ï¸ SLACK_WEBHOOK_URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi
name: ğŸ—„ï¸ Database Management

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'crates/database/**'
      - 'migrations/**'
      - 'schema/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'crates/database/**'
      - 'migrations/**'
      - 'schema/**'
  workflow_dispatch:
    inputs:
      operation:
        description: 'æ•°æ®åº“æ“ä½œ'
        required: true
        default: 'validate'
        type: choice
        options:
          - validate
          - backup
          - migrate
          - sync
      environment:
        description: 'ç›®æ ‡ç¯å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ğŸ” æ•°æ®åº“è¿æ¥æµ‹è¯•
  database-connection-test:
    name: ğŸ” æ•°æ®åº“è¿æ¥æµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-db-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ”§ ç­‰å¾…æœåŠ¡å°±ç»ª
        run: |
          echo "â³ ç­‰å¾…MongoDBå¯åŠ¨..."
          for i in {1..30}; do
            if mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
              echo "âœ… MongoDBå·²å°±ç»ª"
              break
            fi
            sleep 2
          done
          
          echo "â³ ç­‰å¾…Rediså¯åŠ¨..."
          for i in {1..15}; do
            if redis-cli ping > /dev/null 2>&1; then
              echo "âœ… Rediså·²å°±ç»ª"
              break
            fi
            sleep 1
          done

      - name: ğŸ” æ•°æ®åº“è¿æ¥æµ‹è¯•
        env:
          CARGO_ENV: Development
          MONGO_URI: mongodb://localhost:27017
          MONGO_DB: coinfair_test_db
          REDIS_URL: redis://localhost:6379
        run: |
          echo "ğŸ” æµ‹è¯•æ•°æ®åº“ç»„ä»¶..."
          
          # æ„å»ºæ•°æ®åº“crate
          cargo build --package database
          
          # è¿è¡Œæ•°æ®åº“è¿æ¥æµ‹è¯•
          cargo test --package database --lib -- --nocapture --test-threads=1
          
          echo "âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•å®Œæˆ"

      - name: ğŸ“Š æ•°æ®åº“æ¨¡å‹éªŒè¯
        env:
          CARGO_ENV: Development
          MONGO_URI: mongodb://localhost:27017
          MONGO_DB: coinfair_model_test
          REDIS_URL: redis://localhost:6379
        run: |
          echo "ğŸ“Š éªŒè¯æ•°æ®åº“æ¨¡å‹..."
          
          # æµ‹è¯•æ‰€æœ‰æ•°æ®åº“æ¨¡å‹
          cargo test --package database --lib models -- --nocapture
          
          # æµ‹è¯•ä»“åº“æ¨¡å¼
          cargo test --package database --lib repositories -- --nocapture
          
          echo "âœ… æ•°æ®åº“æ¨¡å‹éªŒè¯å®Œæˆ"

  # ğŸ§ª æ•°æ®é›†æˆæµ‹è¯•
  database-integration-test:
    name: ğŸ§ª æ•°æ®é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: database-connection-test
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
      
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-integration-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ”§ å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
        run: |
          echo "ğŸ”§ å‡†å¤‡æµ‹è¯•æ•°æ®..."
          
          # ç­‰å¾…MongoDBå°±ç»ª
          for i in {1..30}; do
            if mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
              echo "âœ… MongoDBå·²å°±ç»ª"
              break
            fi
            sleep 2
          done
          
          # åˆ›å»ºæµ‹è¯•æ•°æ®åº“å’ŒåŸºç¡€æ•°æ®
          mongosh << 'EOF'
          use coinfair_integration_test;
          
          // åˆ›å»ºæµ‹è¯•ç”¨æˆ·æ•°æ®
          db.User.insertMany([
            {
              address: "test_user_1",
              amount: 1000.0,
              price: 1.5,
              timestamp: new Date()
            },
            {
              address: "test_user_2", 
              amount: 2000.0,
              price: 2.0,
              timestamp: new Date()
            }
          ]);
          
          // åˆ›å»ºæµ‹è¯•æ¨èæ•°æ®
          db.Refer.insertMany([
            {
              lower: "test_user_2",
              upper: "test_user_1",
              created_at: new Date()
            }
          ]);
          
          // åˆ›å»ºæµ‹è¯•CLMMæ± å­æ•°æ®
          db.ClmmPool.insertMany([
            {
              pool_address: "test_pool_1",
              token_a_mint: "token_a",
              token_b_mint: "token_b",
              fee_rate: 3000,
              sqrt_price_x64: "1000000000000000000",
              tick: 0,
              liquidity: "1000000",
              created_at: new Date(),
              updated_at: new Date()
            }
          ]);
          
          console.log("âœ… æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆ");
          EOF

      - name: ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•
        env:
          CARGO_ENV: Development
          MONGO_URI: mongodb://localhost:27017
          MONGO_DB: coinfair_integration_test
        run: |
          echo "ğŸ§ª è¿è¡Œæ•°æ®åº“é›†æˆæµ‹è¯•..."
          
          # æµ‹è¯•ç”¨æˆ·ç›¸å…³åŠŸèƒ½
          cargo test --package database test_user_operations -- --nocapture || true
          
          # æµ‹è¯•æ¨èç³»ç»Ÿ
          cargo test --package database test_refer_operations -- --nocapture || true
          
          # æµ‹è¯•CLMMæ± å­
          cargo test --package database test_clmm_pool -- --nocapture || true
          
          # æµ‹è¯•å¥–åŠ±ç³»ç»Ÿ
          cargo test --package database test_reward_operations -- --nocapture || true
          
          echo "âœ… é›†æˆæµ‹è¯•å®Œæˆ"

      - name: ğŸ“Š æ€§èƒ½æµ‹è¯•
        env:
          CARGO_ENV: Development
          MONGO_URI: mongodb://localhost:27017
          MONGO_DB: coinfair_performance_test
        run: |
          echo "ğŸ“Š è¿è¡Œæ•°æ®åº“æ€§èƒ½æµ‹è¯•..."
          
          # æ‰¹é‡æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
          cargo test --package database test_batch_query_performance -- --nocapture || true
          
          # ç´¢å¼•æ€§èƒ½æµ‹è¯•
          cargo test --package server test_database_service_config_creation -- --nocapture || true
          
          echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"

  # ğŸ”„ æ•°æ®åº“åŒæ­¥éªŒè¯
  database-sync-validation:
    name: ğŸ”„ æ•°æ®åº“åŒæ­¥éªŒè¯
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.operation == 'sync'
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ”„ CLMMæ± å­åŒæ­¥æµ‹è¯•
        env:
          CARGO_ENV: Development
          MONGO_URI: mongodb://localhost:27017
          MONGO_DB: coinfair_sync_test
          RPC_URL: https://api.devnet.solana.com
        run: |
          echo "ğŸ”„ æµ‹è¯•CLMMæ± å­åŒæ­¥..."
          
          # æµ‹è¯•æ± å­åŒæ­¥é€»è¾‘
          cargo test --package server test_clmm_sync -- --nocapture || true
          
          echo "âœ… åŒæ­¥æµ‹è¯•å®Œæˆ"

  # ğŸ’¾ æ•°æ®å¤‡ä»½éªŒè¯
  database-backup-validation:
    name: ğŸ’¾ æ•°æ®å¤‡ä»½éªŒè¯
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.operation == 'backup'
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ’¾ æ•°æ®å¤‡ä»½æµ‹è¯•
        run: |
          echo "ğŸ’¾ æµ‹è¯•æ•°æ®åº“å¤‡ä»½åŠŸèƒ½..."
          
          # åˆ›å»ºæµ‹è¯•æ•°æ®
          mongosh << 'EOF'
          use coinfair_backup_test;
          
          db.TestCollection.insertMany([
            { name: "test1", value: 100 },
            { name: "test2", value: 200 }
          ]);
          EOF
          
          # æ‰§è¡Œå¤‡ä»½
          mongodump --host localhost:27017 --db coinfair_backup_test --out /tmp/backup
          
          # éªŒè¯å¤‡ä»½
          if [ -d "/tmp/backup/coinfair_backup_test" ]; then
            echo "âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ"
            ls -la /tmp/backup/coinfair_backup_test/
          else
            echo "âŒ å¤‡ä»½åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          # æµ‹è¯•æ¢å¤
          mongosh << 'EOF'
          use coinfair_backup_test;
          db.dropDatabase();
          EOF
          
          mongorestore --host localhost:27017 /tmp/backup
          
          # éªŒè¯æ¢å¤
          RESULT=$(mongosh --quiet --eval "use coinfair_backup_test; db.TestCollection.countDocuments({})")
          if [ "$RESULT" -eq 2 ]; then
            echo "âœ… æ•°æ®æ¢å¤æˆåŠŸ"
          else
            echo "âŒ æ•°æ®æ¢å¤å¤±è´¥"
            exit 1
          fi

  # ğŸ“‹ ç”Ÿæˆæ•°æ®åº“æŠ¥å‘Š
  database-report:
    name: ğŸ“‹ ç”Ÿæˆæ•°æ®åº“æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [database-connection-test, database-integration-test]
    if: always()
    
    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“‹ ç”Ÿæˆæ•°æ®åº“æ¶æ„æŠ¥å‘Š
        run: |
          echo "ğŸ“‹ ç”Ÿæˆæ•°æ®åº“æ¶æ„åˆ†ææŠ¥å‘Š..."
          
          cat > database-report.md << 'EOF'
          # ğŸ—„ï¸ Coinfairæ•°æ®åº“æ¶æ„æŠ¥å‘Š
          
          ç”Ÿæˆæ—¶é—´: $(date)
          Gitåˆ†æ”¯: ${{ github.ref_name }}
          æäº¤å“ˆå¸Œ: ${{ github.sha }}
          
          ## ğŸ“Š ä¸»è¦é›†åˆç»“æ„
          
          ### ç”¨æˆ·é›†åˆ (User)
          - å­˜å‚¨ç”¨æˆ·åœ°å€ã€äº¤æ˜“é‡‘é¢ã€ä»·æ ¼ä¿¡æ¯
          - ç´¢å¼•: address (å”¯ä¸€)
          
          ### æ¨èå…³ç³» (Refer)  
          - å­˜å‚¨ç”¨æˆ·é—´æ¨èå…³ç³»
          - ç´¢å¼•: lower, upper
          
          ### å¥–åŠ±è®°å½• (Reward)
          - ç®¡ç†å¥–åŠ±åˆ†å‘å’ŒçŠ¶æ€
          - ç´¢å¼•: user_address, status
          
          ### CLMMæ± å­ (ClmmPool)
          - é›†ä¸­æµåŠ¨æ€§åšå¸‚å•†æ± å­ä¿¡æ¯
          - ç´¢å¼•: pool_address, token_mint_pair
          
          ### CLMMé…ç½® (ClmmConfig)
          - CLMMæ± å­é…ç½®å‚æ•°
          - ç´¢å¼•: config_index
          
          ## ğŸ”§ æ•°æ®åº“è¿æ¥é…ç½®
          - MongoDB URI: mongodb://localhost:27017
          - è¿æ¥æ± : æœ€å°2ä¸ªï¼Œæœ€å¤§10ä¸ªè¿æ¥
          - è¶…æ—¶è®¾ç½®: è¿æ¥30sï¼ŒæŸ¥è¯¢60s
          
          ## ğŸš€ æ€§èƒ½ä¼˜åŒ–
          - ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
          - å®ç°æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
          - è¿æ¥æ± å¤ç”¨å‡å°‘è¿æ¥æˆæœ¬
          
          ## ğŸ” æµ‹è¯•è¦†ç›–ç‡
          - å•å…ƒæµ‹è¯•: æ•°æ®æ¨¡å‹éªŒè¯
          - é›†æˆæµ‹è¯•: æ•°æ®åº“æ“ä½œæµç¨‹
          - æ€§èƒ½æµ‹è¯•: æ‰¹é‡æŸ¥è¯¢åŸºå‡†æµ‹è¯•
          EOF
          
          echo "âœ… æ•°æ®åº“æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ æ•°æ®åº“æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: database-report-${{ github.sha }}
          path: database-report.md
          retention-days: 30

      - name: ğŸ“§ æ•°æ®åº“çŠ¶æ€é€šçŸ¥
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ æ•°æ®åº“æµ‹è¯•å¤±è´¥!\nğŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æäº¤è€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\nğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || true
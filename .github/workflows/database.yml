name: ğŸ—„ï¸ Database Management

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'crates/database/**'
      - 'migrations/**'
      - 'schema/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'crates/database/**'
      - 'migrations/**'  
      - 'schema/**'
  workflow_dispatch:
    inputs:
      operation:
        description: 'æ•°æ®åº“æ“ä½œ'
        required: true
        default: 'check'
        type: choice
        options:
          - check
          - backup
          - schema

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ğŸ” æ•°æ®åº“åŒ…æ£€æŸ¥
  database-check:
    name: ğŸ” æ•°æ®åº“åŒ…æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ¦€ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ ç¼“å­˜Cargoä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-database-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: âš¡ å¿«é€Ÿæ•°æ®åº“åŒ…æ£€æŸ¥
        run: |
          echo "âš¡ å¿«é€Ÿæ•°æ®åº“åŒ…æ£€æŸ¥..."
          cargo check --package database || echo "âš ï¸ databaseåŒ…ç¼–è¯‘æœ‰é—®é¢˜"
          echo "âœ… å¿«é€Ÿæ£€æŸ¥å®Œæˆ"

  # ğŸ“§ æ•°æ®åº“çŠ¶æ€é€šçŸ¥
  notify-database-status:
    name: ğŸ“§ æ•°æ®åº“çŠ¶æ€é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [database-check]
    if: always() && !cancelled()
    
    steps:
      - name: ğŸ“§ å‘é€æˆåŠŸé€šçŸ¥
        if: needs.database-check.result == 'success'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"âœ… æ•°æ®åº“æ£€æŸ¥é€šè¿‡!\nğŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æäº¤è€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "â„¹ï¸ SLACK_WEBHOOK_URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi

      - name: ğŸš¨ å‘é€å¤±è´¥é€šçŸ¥
        if: needs.database-check.result == 'failure'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥!\nğŸ“‹ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æäº¤è€…: ${{ github.actor }}\nâ° æ—¶é—´: $(date)\"}" \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          else
            echo "â„¹ï¸ SLACK_WEBHOOK_URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
          fi